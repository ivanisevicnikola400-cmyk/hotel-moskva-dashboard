<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>eMenadÅ¾er â€” Hotel Management System</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0B0E14;--sf:#12161F;--bd:#1C2130;--bl:#252B3B;--tx:#E0E4EC;--dim:#6B7280;--dk:#3D4455;--grn:#22C55E;--blu:#3B82F6;--yel:#EAB308;--red:#EF4444;--gld:#C9A84C}
body{background:var(--bg);color:var(--tx);font-family:'Segoe UI',system-ui,sans-serif;height:100vh;overflow:hidden}
.app{display:grid;grid-template-columns:240px 1fr 300px;grid-template-rows:56px 1fr;height:100vh}
.hdr{grid-column:1/-1;background:var(--sf);border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:10}
.side{grid-row:2;background:var(--sf);border-right:1px solid var(--bd);overflow-y:auto;padding:14px}
.main{grid-row:2;overflow-y:auto;padding:20px;background:var(--bg)}
.pan{grid-row:2;background:var(--sf);border-left:1px solid var(--bd);overflow-y:auto;display:flex;flex-direction:column}
.logo{display:flex;align-items:center;gap:10px}
.logo-i{width:32px;height:32px;background:linear-gradient(135deg,var(--gld),#8B6914);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:#FFF}
.logo-t{font-size:16px;font-weight:700;color:#FFF;letter-spacing:1px}
.logo-s{font-size:9px;color:var(--dim);letter-spacing:2px;text-transform:uppercase}
.fnav{display:flex;gap:3px;background:var(--bg);padding:3px;border-radius:8px;border:1px solid var(--bd)}
.fb{padding:5px 14px;border:none;background:none;color:var(--dim);font-size:11px;font-weight:500;border-radius:6px;cursor:pointer;transition:all .2s;font-family:inherit}
.fb.act{background:var(--gld);color:#0B0E14;font-weight:700}
.fb:hover:not(.act){color:var(--tx);background:rgba(255,255,255,.05)}
.hstats{display:flex;align-items:center;gap:14px}
.hs{text-align:center}.hs-v{font-size:16px;font-weight:700}.hs-l{font-size:8px;color:var(--dim);letter-spacing:1px;text-transform:uppercase}
.hs-v.g{color:var(--grn)}.hs-v.b{color:var(--blu)}.hs-v.y{color:var(--yel)}.hs-v.r{color:var(--red)}
.clk{font-size:18px;font-weight:700;color:#FFF;font-variant-numeric:tabular-nums}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--grn);animation:bk 1.5s infinite;display:inline-block;margin-right:4px}
.stit{font-size:9px;color:var(--dim);letter-spacing:2px;text-transform:uppercase;margin:12px 0 8px}
.leg{display:flex;flex-direction:column;gap:6px;margin-bottom:16px}
.legi{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--dim)}
.legd{width:10px;height:10px;border-radius:3px}
.legd.g{background:var(--grn)}.legd.b{background:var(--blu)}.legd.y{background:var(--yel);animation:bk 1.5s infinite}.legd.r{background:var(--red);animation:bk .8s infinite}
.sc{background:var(--bg);border:1px solid var(--bd);border-radius:8px;padding:12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.sc-l{font-size:10px;color:var(--dim)}.sc-v{font-size:16px;font-weight:700}
.si{display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;margin-bottom:3px;background:var(--bg);border:1px solid var(--bd)}
.sav{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#FFF}
.san{font-size:11px;font-weight:500}.sar{font-size:9px;color:var(--dim)}
.sas{width:7px;height:7px;border-radius:50%;margin-left:auto}.sas.on{background:var(--grn)}.sas.bs{background:var(--yel)}
.flab{font-size:20px;font-weight:700;color:#FFF;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.flab span{font-size:11px;color:var(--dim);font-weight:400;letter-spacing:1px}
.rrow{display:grid;gap:8px;margin:5px 0}
.hall{background:var(--sf);border:1px solid var(--bd);border-radius:6px;padding:6px;text-align:center;font-size:9px;color:var(--dk);letter-spacing:3px;text-transform:uppercase;margin:4px 0}
.rm{position:relative;background:var(--sf);border:2px solid var(--bd);border-radius:10px;padding:16px 12px;text-align:center;cursor:pointer;transition:all .3s;min-height:90px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.rm:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
.rn{font-size:20px;font-weight:700;color:#FFF;margin-bottom:2px}
.rt{font-size:8px;color:var(--dim);letter-spacing:1px;text-transform:uppercase}
.rg{font-size:9px;color:var(--dim);margin-top:4px;font-style:italic;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}
.rb{position:absolute;top:-5px;right:-5px;width:18px;height:18px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#FFF}
.rm.v{border-color:rgba(34,197,94,.2);background:rgba(34,197,94,.06)}.rm.v .rn{color:var(--grn)}
.rm.o{border-color:rgba(59,130,246,.2);background:rgba(59,130,246,.06)}.rm.o .rn{color:var(--blu)}
.rm.q{border-color:rgba(234,179,8,.25);background:rgba(234,179,8,.06);animation:py 1.5s infinite}.rm.q .rn{color:var(--yel)}.rm.q .rb{display:flex;background:var(--yel)}
.rm.u{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.06);animation:pr .8s infinite}.rm.u .rn{color:var(--red)}.rm.u .rb{display:flex;background:var(--red)}
@keyframes py{0%,100%{box-shadow:0 0 0 0 rgba(234,179,8,.3)}50%{box-shadow:0 0 16px 3px rgba(234,179,8,.12)}}
@keyframes pr{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.4)}50%{box-shadow:0 0 20px 4px rgba(239,68,68,.15)}}
@keyframes bk{0%,100%{opacity:1}50%{opacity:.3}}
.ph{padding:12px 16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
.pt{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--dim)}
.pc{background:var(--red);color:#FFF;font-size:9px;font-weight:700;padding:2px 7px;border-radius:8px}
.nots{flex:1;overflow-y:auto;padding:6px}
.nt{padding:12px 14px;border-radius:8px;margin-bottom:5px;cursor:pointer;transition:all .2s;border-left:3px solid transparent}
.nt:hover{background:rgba(255,255,255,.02)}
.nt.u{background:rgba(239,68,68,.06);border-left-color:var(--red)}
.nt.q{background:rgba(234,179,8,.06);border-left-color:var(--yel)}
.nt.d{opacity:.5;border-left-color:var(--grn)}
.ntp{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.ntr{font-weight:700;font-size:12px}.ntr.u{color:var(--red)}.ntr.q{color:var(--yel)}
.ntt{font-size:8px;color:var(--dk)}
.ntm{font-size:11px;color:var(--dim);line-height:1.4}
.ntg{display:inline-block;font-size:8px;padding:2px 6px;border-radius:3px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-top:4px}
.ntg.u{background:rgba(239,68,68,.12);color:var(--red)}.ntg.q{background:rgba(234,179,8,.12);color:var(--yel)}
.nta{display:flex;gap:4px;margin-top:6px}
.nb{padding:4px 10px;border-radius:5px;font-size:9px;font-weight:600;border:none;cursor:pointer;font-family:inherit;transition:all .2s}
.nb.rs{background:var(--grn);color:#FFF}.nb.as{background:var(--bl);color:var(--dim)}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:100;display:none;align-items:center;justify-content:center}
.mo.sh{display:flex}
.md{background:var(--sf);border:1px solid var(--bd);border-radius:14px;width:400px;max-width:90vw;overflow:hidden}
.mh{padding:16px 20px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center}
.mrm{font-size:22px;font-weight:700}
.mc{width:28px;height:28px;border-radius:6px;border:1px solid var(--bd);background:none;color:var(--dim);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.mc:hover{background:var(--bd);color:var(--tx)}
.mb{padding:20px}
.mro{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--bd);font-size:12px}
.mrl{color:var(--dim)}.mrv{color:#FFF;font-weight:500}
.conn{font-size:9px;padding:3px 8px;border-radius:4px;font-weight:600}
.conn.ok{background:rgba(34,197,94,.15);color:var(--grn)}.conn.err{background:rgba(239,68,68,.15);color:var(--red)}
@media(max-width:1000px){.app{grid-template-columns:1fr}.side,.pan{display:none}}
</style>
</head>
<body>
<div class="app">
<div class="hdr">
  <div class="logo"><div class="logo-i">e</div><div><div class="logo-t">eMenadÅ¾er</div><div class="logo-s">Hotel Moskva</div></div></div>
  <div class="fnav" id="fnav"></div>
  <div class="hstats">
    <div class="hs"><div class="hs-v g" id="sv">0</div><div class="hs-l">Slobodne</div></div>
    <div class="hs"><div class="hs-v b" id="so">0</div><div class="hs-l">Zauzete</div></div>
    <div class="hs"><div class="hs-v y" id="sq">0</div><div class="hs-l">Zahtevi</div></div>
    <div class="hs"><div class="hs-v r" id="su">0</div><div class="hs-l">Hitno</div></div>
    <div style="width:1px;height:28px;background:var(--bd)"></div>
    <span class="conn ok" id="connStatus"><span class="live-dot"></span>LIVE</span>
    <div class="clk" id="clk">--:--</div>
  </div>
</div>
<div class="side">
  <div class="stit">Legenda</div>
  <div class="leg">
    <div class="legi"><div class="legd g"></div>Slobodna soba</div>
    <div class="legi"><div class="legd b"></div>Zauzeta â€” sve OK</div>
    <div class="legi"><div class="legd y"></div>Custom zahtev</div>
    <div class="legi"><div class="legd r"></div>Hitan problem</div>
  </div>
  <div class="stit">Statistika danas</div>
  <div class="sc"><span class="sc-l">Aktivni gosti</span><span class="sc-v" id="sGuests">0</span></div>
  <div class="sc"><span class="sc-l">Ukupno zahteva</span><span class="sc-v" id="sReqs">0</span></div>
  <div class="sc"><span class="sc-l">ReÅ¡eno danas</span><span class="sc-v" style="color:var(--grn)" id="sResolved">0</span></div>
  <div class="sc"><span class="sc-l">Aktivni zahtevi</span><span class="sc-v" style="color:var(--yel)" id="sActive">0</span></div>
  <div class="stit" style="margin-top:16px">Osoblje na duÅ¾nosti</div>
  <div class="si"><div class="sav" style="background:var(--blu)">MJ</div><div><div class="san">Marko JovanoviÄ‡</div><div class="sar">Housekeeping</div></div><div class="sas on"></div></div>
  <div class="si"><div class="sav" style="background:var(--gld)">AP</div><div><div class="san">Ana PetroviÄ‡</div><div class="sar">Recepcija</div></div><div class="sas on"></div></div>
  <div class="si"><div class="sav" style="background:var(--grn)">DN</div><div><div class="san">Dragan NikoliÄ‡</div><div class="sar">OdrÅ¾avanje</div></div><div class="sas bs"></div></div>
  <div class="si"><div class="sav" style="background:var(--red)">IB</div><div><div class="san">Ivana BogdanoviÄ‡</div><div class="sar">Room Service</div></div><div class="sas on"></div></div>
</div>
<div class="main" id="mainA"></div>
<div class="pan">
  <div class="ph"><span class="pt">ObaveÅ¡tenja</span><span class="pc" id="nc">0</span></div>
  <div class="nots" id="nl"></div>
</div>
</div>
<div class="mo" id="modal" onclick="if(event.target===this)cm()"><div class="md"><div class="mh"><span class="mrm" id="mrm"></span><button class="mc" onclick="cm()">âœ•</button></div><div class="mb" id="mbd"></div></div></div>
<script>
const API_BASE = 'https://nolimitnikola.app.n8n.cloud/webhook';
const API_DASH = API_BASE + '/emanadzer-dashboard';
const API_RESOLVE = API_BASE + '/emanadzer-resolve';
const POLL_INTERVAL = 5000;

let CF = 1, DATA = null, prevNotifCount = 0;

// Fallback floor layout if API hasn't loaded yet
const FLOORS_DEFAULT = [
  {id:1,name:'1. sprat',label:'Prizemlje',rows:[[{n:'101',t:'Economy'},{n:'102',t:'Std Twin'},{n:'103',t:'Std King'},{n:'104',t:'Economy'},{n:'105',t:'Std King'}],[{n:'106',t:'Superior'},{n:'107',t:'Std King'},{n:'108',t:'Economy'},{n:'109',t:'Std Twin'},{n:'110',t:'Economy'}]]},
  {id:2,name:'2. sprat',label:'Drugi sprat',rows:[[{n:'201',t:'Superior'},{n:'202',t:'Std King'},{n:'203',t:'Jr Suite'},{n:'204',t:'Std Twin'},{n:'205',t:'Superior'}],[{n:'206',t:'Std King'},{n:'207',t:'Superior'},{n:'208',t:'Economy'},{n:'209',t:'Std King'},{n:'210',t:'Superior'}]]},
  {id:3,name:'3. sprat',label:'TreÄ‡i sprat',rows:[[{n:'301',t:'Premium'},{n:'302',t:'Superior'},{n:'303',t:'Std King'},{n:'304',t:'Superior'},{n:'305',t:'Std Twin'}],[{n:'306',t:'Std King'},{n:'307',t:'Jr Suite'},{n:'308',t:'Superior'},{n:'309',t:'Economy'},{n:'310',t:'Std King'}]]},
  {id:4,name:'4. sprat',label:'ÄŒetvrti sprat',rows:[[{n:'401',t:'Royal'},{n:'402',t:'Premium'},{n:'403',t:'Jr Suite'}],[{n:'404',t:'Presidential'},{n:'405',t:'Royal'}]]}
];

function getFloors() {
  return (DATA && DATA.floors) ? DATA.floors : FLOORS_DEFAULT;
}

function bf() {
  document.getElementById('fnav').innerHTML = getFloors().map(f =>
    '<button class="fb ' + (f.id === CF ? 'act' : '') + '" onclick="sf(' + f.id + ')">' + f.name + '</button>'
  ).join('');
}

function sf(id) { CF = id; bf(); rf(); }

function rf() {
  const f = getFloors().find(x => x.id === CF);
  if (!f) return;
  const total = f.rows.reduce((s, r) => s + r.length, 0);
  document.getElementById('mainA').innerHTML =
    '<div class="flab">' + f.label + ' <span>' + f.name + ' â€” ' + total + ' soba</span></div>' +
    '<div class="rrow" style="grid-template-columns:repeat(' + f.rows[0].length + ',1fr)">' + f.rows[0].map(rh).join('') + '</div>' +
    '<div class="hall">H O D N I K</div>' +
    (f.rows[1] ? '<div class="rrow" style="grid-template-columns:repeat(' + f.rows[1].length + ',1fr)">' + f.rows[1].map(rh).join('') + '</div>' : '');
}

function rh(rm) {
  const st = rm.state || 'v';
  const s = st === 'vacant' ? 'v' : st === 'occupied' ? 'o' : st === 'request' ? 'q' : st === 'urgent' ? 'u' : st;
  const g = rm.guest || '';
  const bg = s === 'u' ? '!' : s === 'q' ? '?' : '';
  return '<div class="rm ' + s + '" onclick="om(\'' + rm.n + '\')">' +
    '<div class="rb">' + bg + '</div>' +
    '<div class="rn">' + rm.n + '</div>' +
    '<div class="rt">' + rm.t + '</div>' +
    (g ? '<div class="rg">' + g + '</div>' : '') +
    '</div>';
}

function us() {
  if (!DATA || !DATA.stats) return;
  const s = DATA.stats;
  document.getElementById('sv').textContent = s.vacant || 0;
  document.getElementById('so').textContent = s.occupied || 0;
  document.getElementById('sq').textContent = s.request || 0;
  document.getElementById('su').textContent = s.urgent || 0;
  document.getElementById('sGuests').textContent = s.activeGuests || 0;
  document.getElementById('sReqs').textContent = s.totalRequests || 0;
  document.getElementById('sResolved').textContent = s.resolvedToday || 0;
  document.getElementById('sActive').textContent = s.activeRequests || 0;
  const active = (s.request || 0) + (s.urgent || 0);
  document.getElementById('nc').textContent = active;
}

function rn() {
  if (!DATA || !DATA.notifications) return;
  const nots = DATA.notifications;
  document.getElementById('nl').innerHTML = nots.map(n =>
    '<div class="nt ' + (n.resolved ? 'd' : n.type) + '" onclick="fr(\'' + n.room + '\')">' +
      '<div class="ntp"><span class="ntr ' + n.type + '">Soba ' + n.room + (n.guest ? ' â€” ' + n.guest : '') + '</span><span class="ntt">' + n.time + '</span></div>' +
      '<div class="ntm">' + n.message + '</div>' +
      '<span class="ntg ' + n.type + '">' + (n.type === 'u' ? 'âš  HITNO' : 'ðŸ“‹ ZAHTEV') + '</span>' +
      (!n.resolved ? '<div class="nta"><button class="nb rs" onclick="event.stopPropagation();rv(\'' + n.id + '\')">âœ“ ReÅ¡eno</button><button class="nb as" onclick="event.stopPropagation()">Dodeli</button></div>' : '<div style="font-size:9px;color:var(--grn);margin-top:4px">âœ“ ReÅ¡eno</div>') +
    '</div>'
  ).join('');

  // Auto-switch floor on new urgent
  const activeUrgent = nots.filter(n => !n.resolved && n.type === 'u');
  if (activeUrgent.length > 0 && nots.filter(n => !n.resolved).length > prevNotifCount) {
    const urgRoom = activeUrgent[0].room;
    const flNum = parseInt(urgRoom[0]);
    if (flNum !== CF) sf(flNum);
    setTimeout(() => highlightRoom(urgRoom), 300);
    playAlert();
  }
  prevNotifCount = nots.filter(n => !n.resolved).length;
}

function fr(r) {
  const fl = parseInt(r[0]);
  if (fl !== CF) sf(fl);
  setTimeout(() => highlightRoom(r), 200);
}

function highlightRoom(r) {
  document.querySelectorAll('.rm').forEach(el => {
    if (el.querySelector('.rn') && el.querySelector('.rn').textContent === r) {
      el.style.outline = '3px solid #FFF';
      el.style.outlineOffset = '3px';
      setTimeout(() => { el.style.outline = ''; el.style.outlineOffset = ''; }, 2000);
    }
  });
}

function om(r) {
  document.getElementById('mrm').textContent = 'Soba ' + r;
  const rs = DATA && DATA.roomState && DATA.roomState[r] ? DATA.roomState[r] : {state:'vacant',guest:'',source:''};
  const stMap = {vacant:'Slobodna',occupied:'Zauzeta',request:'Zahtev',urgent:'HITNO',v:'Slobodna',o:'Zauzeta',q:'Zahtev',u:'HITNO'};
  const cMap = {vacant:'var(--grn)',occupied:'var(--blu)',request:'var(--yel)',urgent:'var(--red)',v:'var(--grn)',o:'var(--blu)',q:'var(--yel)',u:'var(--red)'};
  const rm = getFloors().flatMap(f => f.rows.flat()).find(x => x.n === r);
  const hist = DATA && DATA.notifications ? DATA.notifications.filter(x => x.room === r) : [];
  document.getElementById('mbd').innerHTML =
    '<div class="mro"><span class="mrl">Status</span><span class="mrv" style="color:' + (cMap[rs.state]||'var(--dim)') + '">' + (stMap[rs.state]||rs.state) + '</span></div>' +
    '<div class="mro"><span class="mrl">Tip sobe</span><span class="mrv">' + (rm ? rm.t : 'N/A') + '</span></div>' +
    '<div class="mro"><span class="mrl">Gost</span><span class="mrv">' + (rs.guest || 'â€”') + '</span></div>' +
    '<div class="mro"><span class="mrl">Izvor</span><span class="mrv">' + (rs.source || 'â€”') + '</span></div>' +
    '<div class="mro"><span class="mrl">Sprat</span><span class="mrv">' + r[0] + '. sprat</span></div>' +
    (hist.length ? '<div style="margin-top:14px"><div style="font-size:9px;color:var(--dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">Istorija zahteva</div>' +
    hist.map(h => '<div style="font-size:10px;color:var(--dim);padding:5px 0;border-bottom:1px solid var(--bd)"><span style="color:' + (h.type === 'u' ? 'var(--red)' : 'var(--yel)') + '">[' + h.time + ']</span> ' + h.message + (h.resolved ? ' <span style="color:var(--grn)">âœ“</span>' : '') + '</div>').join('') + '</div>' : '');
  document.getElementById('modal').classList.add('sh');
}

function cm() { document.getElementById('modal').classList.remove('sh'); }

async function rv(reqId) {
  try {
    await fetch(API_RESOLVE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ requestId: reqId })
    });
    fetchData(); // refresh immediately
  } catch (e) { console.error('Resolve error:', e); }
}

function playAlert() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value = 880; o.type = 'sine';
    g.gain.value = 0.15;
    o.start(); o.stop(ctx.currentTime + 0.3);
  } catch(e) {}
}

function uc() {
  const d = new Date();
  document.getElementById('clk').textContent = d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0') + ':' + d.getSeconds().toString().padStart(2,'0');
}

async function fetchData() {
  try {
    const r = await fetch(API_DASH);
    DATA = await r.json();
    document.getElementById('connStatus').className = 'conn ok';
    document.getElementById('connStatus').innerHTML = '<span class="live-dot"></span>LIVE';
    bf(); rf(); us(); rn();
  } catch (e) {
    console.error('API error:', e);
    document.getElementById('connStatus').className = 'conn err';
    document.getElementById('connStatus').textContent = 'OFFLINE';
  }
}

// Init
bf(); rf(); uc();
setInterval(uc, 1000);
fetchData();
setInterval(fetchData, POLL_INTERVAL);
</script>
</body>
</html>
